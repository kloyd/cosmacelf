                        ;;;;;;;;;;;;;;
                        ;
                        ;   Core of Threaded Interpretive Language I/O
                        ;
                        ;;;;;;;;;;;;;;;;;
                        
                        
                        ; named registers
   0002                 SP	EQU	2	; stack pointer
   0003                 PC	EQU	3	; program counter
   0004                 CALLR	EQU	4	; call register
   0005                 RETR	EQU	5	; return register
   0007                 TXTPTR	EQU	7	; text pointer
   0008                 INBUF	EQU	8	; Input line buffer pointer register.
                        ; TIL registers
   000a                 I	EQU	10
   000b                 WA	EQU	11
   000c                 TPC	EQU	12
                        
                        
                        ;; Stack for ram High - top of ram, minus monitor scratch pad area.
   ffbf                 UserStack EQU 0FFBFH
                        ;; SCRT routine locations Standard ROM org'd at 0
   0adb                 CALL	EQU 0ADBH
   0aed                 RETURN	EQU 0AEDH
                        ; I/O ROUTINES
   0526                 OUTSTR	EQU 0526H
                        ;The Monitor "INPUT" routine is at 8005hex in the ORG'ed 8000hex Monitor
                        ;The inputted character is returned in RB.0
   000b                 INDATA	EQU 11
   0005                 INCHR	EQU 0005H
                        ;;The Monitor "OUTPUT" routine is at 821Dhex in the ORG'ed 8000hex Monitor
                        ;;The character to be outputted is stored in RB.0
   021d                 OUTCHR	EQU 021DH
                        
                        ; Start at 8000h for ROM @ 0000h
   8000                 	ORG 8000H
                        	; Setup for SCRT routines.
                        	; Set R3 as program counter
   8000   f8 80 b3 f8   	LOAD PC, main
   8004   07 a3         
   8006   d3            	SEP PC
                        	; Main program entry.	
                        	; Setup stack pointer
   8007   f8 ff b2 f8   main	LOAD SP, UserStack
   800b   bf a2         
   800d   e2            	SEX SP
                        	; Setup 4 to CALL routine 8ADB
   800e   f8 0a b4 f8   	LOAD CALLR, CALL
   8012   db a4         
                        	; Setup R5 to RETURN (8AED)
   8014   f8 0a b5 f8   	LOAD RETR, RETURN
   8018   ed a5         
                        	; R7 points to string.
                        	; Use SCRT 
                        	; R3 is the PC
                        	; R4 is the call register - points to the call routine in rom
                        	; R5 is the return register - points to return routine in rom
                        	; CALL pseudo-op of the A18 assembler
                        	; Set program counter to R4 and follow with word address of the routine to be called.
   801a   f8 80 b7 f8   	LOAD TXTPTR, GREET
   801e   4a a7         
   8020   d4 05 26      	CALL OUTSTR
                        
   8023   f8 80 b7 f8   INLINE	LOAD TXTPTR, PROMPT
   8027   60 a7         
   8029   d4 05 26      	CALL OUTSTR
                        	
                        	; Read a char, echo a char
                        	; if ctrl-c stop
   802c   d4 00 05      IOLOOP	CALL INCHR
   802f   8b            	GLO INDATA     ; io leaves in RB.0
   8030   fd 03         	SDI 3 ; subtract ctrl-c
   8032   32 49         	BZ EXIT
                        	;; simplistic now, must add typed chars to a buffer.
                        	;;
                        	;; CHECK FOR <CR>
   8034   8b            	GLO INDATA
   8035   fd 0d         	SDI 13 ; CR?
   8037   32 3e         	BZ EXECBUF  ; YES - GOTO EXECUTE BUFFER
   8039   d4 02 1d      	CALL OUTCHR ; ECHO CHARACTER
   803c   30 2c         	BR IOLOOP
                        	
   803e   f8 80 b7 f8   EXECBUF	LOAD TXTPTR, OKMSG
   8042   5c a7         
   8044   d4 05 26      	CALL OUTSTR
   8047   30 23         	BR INLINE
                        	
                        	; Exit to Membership Card monitor.
   8049   d1            EXIT	SEP 1
                        	
                        	; Cold start
   804a   48 65 6c 6c   GREET	TEXT "Hello, I'm a TIL."
   804e   6f 2c 20 49   
   8052   27 6d 20 61   
   8056   20 54 49 4c   
   805a   2e            
   805b   00            	BYTE 0
                        
   805c   20 4f 4b      OKMSG	TEXT " OK"
   805f   00            	BYTE  0
                        	
   8060   0d 0a 24 00   PROMPT	BYTE 0DH, 0AH, 24H, 00
                        
                        
   8064                 	END
0adb  CALL          0004  CALLR         803e  EXECBUF       8049  EXIT      
804a  GREET         000a  I             0008  INBUF         0005  INCHR     
000b  INDATA        8023  INLINE        802c  IOLOOP        805c  OKMSG     
021d  OUTCHR        0526  OUTSTR        0003  PC            8060  PROMPT    
0005  RETR          0aed  RETURN        0002  SP            000c  TPC       
0007  TXTPTR        ffbf  UserStack     000b  WA            8007  main      
