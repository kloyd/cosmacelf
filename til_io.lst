                        	CPU 1802
                        
                        ;
                        ; Register Definitions:
                        ;
   0000                 R0	EQU	0
   0001                 R1	EQU	1
   0002                 R2	EQU	2
   0003                 R3	EQU	3
   0004                 R4	EQU	4
   0005                 R5	EQU	5
   0006                 R6	EQU	6
   0007                 R7	EQU	7
   0008                 R8	EQU	8
   0009                 R9	EQU	9
   000a                 R10	EQU	10
   000b                 R11	EQU	11
   000c                 R12	EQU	12
   000d                 R13	EQU	13
   000e                 R14	EQU	14
   000f                 R15	EQU	15
                        
                        ;; named registers
   0002                 SP	EQU	2
   0003                 PC	EQU	3
   0004                 CALLR	EQU	4
   0005                 RETR	EQU	5
   0007                 TXTPTR	EQU	7
   0008                 INBUF	EQU	8	; Input line buffer pointer register.
                        ; TIL registers
   000a                 I	EQU	10
   000b                 WA	EQU	11
   000c                 TPC	EQU	12
                        
                        
                        ;; Stack for ram High - top of ram, minus monitor scratch pad area.
   ffbf                 UserStack EQU 0FFBFH
                        ;; SCRT routine locations Standard ROM org'd at 0
                        ; 
   0adb                 CALL	EQU 0ADBH
   0aed                 RETURN	EQU 0AEDH
                        ; I/O ROUTINES
   0526                 OUTSTR	EQU 0526H
                        
                        ;The Monitor "INPUT" routine is at 8005hex in the ORG'ed 8000hex Monitor
                        ;The inputted character is returned in RB.0
   000b                 INDATA	EQU 11
   0005                 INCHR	EQU 0005H
                        ;;The Monitor "OUTPUT" routine is at 821Dhex in the ORG'ed 8000hex Monitor
                        ;;The character to be outputted is stored in RB.0
   021d                 OUTCHR	EQU 021DH
                        
   8000                 	ORG 8000H
                        	; Setup for SCRT routines.
                        	; Set R3 as program counter
   8000   f8 80         	LDI HIGH main
   8002   b3            	PHI PC
   8003   f8 07         	LDI LOW main
   8005   a3            	PLO PC
   8006   d3            	SEP PC
                        	; Main program entry.	
                        	; Setup stack pointer R2 @7FBFh
   8007   f8 ff         main	LDI HIGH UserStack
   8009   b2            	PHI R2
   800a   f8 bf         	LDI LOW UserStack
   800c   a2            	PLO R2
   800d   e2            	SEX R2
                        	; Setup 4 to CALL routine 8ADB
   800e   f8 0a         	LDI	HIGH CALL
   8010   b4            	PHI	R4
   8011   f8 db         	LDI	LOW CALL
   8013   a4            	PLO	R4
                        	; Setup R5 to RETURN (8AED)
   8014   f8 0a         	LDI	HIGH RETURN
   8016   b5            	PHI	R5
   8017   f8 ed         	LDI	LOW RETURN
   8019   a5            	PLO	R5
                        	
                        	; R7 points to string.
                        	; Use SCRT 
                        	; R3 is the PC
                        	; R4 is the call register - points to the call routine in rom
                        	; R5 is the return register - points to return routine in rom
                        	; CALL pseudo-op of the A18 assembler
                        	; Set program counter to R4 and follow with word address of the routine to be called.
   801a   f8 80 b7 f8   	LOAD TXTPTR, GREET
   801e   48 a7         
   8020   d4 05 26      	CALL OUTSTR
                        
   8023   f8 80 b7 f8   INLINE	LOAD TXTPTR, PROMPT
   8027   5e a7         
   8029   d4 05 26      	CALL OUTSTR
                        	
                        	; Read a char, echo a char
                        	; if ctrl-c stop
   802c   d4 00 05      IOLOOP	CALL INCHR
   802f   d4 02 1d      	CALL OUTCHR
   8032   8b            	GLO INDATA     ; io leaves in RB.0
   8033   fd 03         	SDI 3 ; subtract ctrl-c
   8035   32 47         	BZ EXIT
                        	;; simplistic now, must add typed chars to a buffer.
                        	;;
                        	;;
   8037   8b            	GLO INDATA
   8038   fd 0d         	SDI 13 ; CR?
   803a   39 2c         	BNQ IOLOOP
   803c   f8 80 b7 f8   	LOAD TXTPTR, OKMSG
   8040   5a a7         
   8042   d4 05 26      	CALL OUTSTR
   8045   30 23         	BR INLINE
                        	
                        	; Exit to Membership Card monitor.
   8047   d1            EXIT	SEP 1
                        	
                        	; Cold start
   8048   48 65 6c 6c   GREET	TEXT "Hello, I'm a TIL."
   804c   6f 2c 20 49   
   8050   27 6d 20 61   
   8054   20 54 49 4c   
   8058   2e            
   8059   00            	BYTE 0
                        
   805a   20 4f 4b      OKMSG	TEXT " OK"
   805d   00            	BYTE 0
                        	
   805e   0d 0a 24 00   PROMPT	BYTE 0DH, 0AH, 24H, 00
                        
                        
   8062                 	END
0adb  CALL          0004  CALLR         8047  EXIT          8048  GREET     
000a  I             0008  INBUF         0005  INCHR         000b  INDATA    
8023  INLINE        802c  IOLOOP        805a  OKMSG         021d  OUTCHR    
0526  OUTSTR        0003  PC            805e  PROMPT        0000  R0        
0001  R1            000a  R10           000b  R11           000c  R12       
000d  R13           000e  R14           000f  R15           0002  R2        
0003  R3            0004  R4            0005  R5            0006  R6        
0007  R7            0008  R8            0009  R9            0005  RETR      
0aed  RETURN        0002  SP            000c  TPC           0007  TXTPTR    
ffbf  UserStack     000b  WA            8007  main          
